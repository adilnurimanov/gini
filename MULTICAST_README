COMP535 - Programming Assignment 2
IP Multicasting
Samuel Cormier-Iijima (260174995), Michael Spivack (260224370)

We have implemented IP multicast using IGMP v1 for group memberships and a
protocol similar to DVMRP for building the source-based distribution tree.

A couple of changes were made to GINI, most notably -Wall -Werror was added to
the compilation flags to simplify debugging. This exposed many pre-existing
bugs in GINI as well.

The multicast.c file stores a list of multicast groups for each router interface
using a balanced binary tree data structure provided by GLib, which maps
multicast group addresses (keys) to a timestamp of the last received membership
report (values). On initialization, a callback is added to the main event loop
(which was added in grouter.c, also using GLib builtins) which removes expired
memberships. The timeout values can be changed in multicast.h.

The IGMP module is implemented in igmp.c. On initialization, a small number of
queries are sent out (according to the RFC), and a timeout callback is added
which sends IGMP queries at a larger interval (usually every minute). These
timeouts can also be configured in igmp.h. This file also provides a simple
command-line tool called mcast, which displays a list of groups along with
their last update time for every interface. The IGMP module was tested using
the two-LAN topology given in the assignment, and worked correctly once the
UMLs were configured to use IGMPv1 instead of v3.

The dvmrp.c file implements a simple DVMRP-like protocol to build and maintain
a source-based distribution tree. Since GINI does not support dynamic
topology changes, we decided not to implement the dynamic routing algorithm
that DVMRP and RIP provide. Thus, instead of maintaining its own routing
table that includes a metric, this protocol simply uses the static routing
information provided by the GINI route table.

Because of this limitation, some of the information needed by Reverse Path
Multicasting (RPM) is not available. Specifically, the router cannot
determine which of the virtual networks it is connected to are children
(usually found by Reverse Path Broadcasting, or RPB) and which are leaves
(found using Truncated Reverse Path Broadcasting, or TRPB). Instead, we
extend the pruning protocol to include a LEAF message saying that the neighbor
router does not want to receive ANY messages from the given source, regardless
of the multicast group. This takes the place of determining leaves in DVMRP,
since implementing the full dynamic routing algorithm would be too complicated
for this assignment, and since GINI routers can only be connected either to a
single other router or a LAN of hosts (GINI doesn't support multiple routers
connected to a switch). This works under the assumption that the network
topology doesn't change on-the-fly. Also, although we didn't implement timeouts
for the LEAF messages (they remain active indefinitely), the code should be
extensible enough to easily add support for this.

Also, since GINI does not provide a way to know whether an interface is
connected to another router or to a LAN of hosts, we decided to send packets
to the multicast ALL_ROUTER address to ping for other routers. If no reply
is received, we assume that the memberships for that link can be managed
by IGMP.

See [1], [2], and [3] a more in-depth discussion of this subject.

We tested this distribution tree algorithm using the more complicated topology
given in the assignment and reproduced below. The LEAF messages allowed pruning
to happen, since without them Router2 would forward messages from Router3 to
Router1. The algorithm works as follows:

    UML1                            UML3
     \                               /
    Router1                      Router5
      |    \                    /   |
      |     Router3 ---- Router4    |
      |    /                    \   |
    Router2                      Router6
     /                               \
    UML2                            UML4

On startup, every router initializes each of its interfaces as an edge in the
gini_dvmrp_edges array, and sends DVMRP PROBE messages on every link to the
ALL_ROUTERS broadcast. When a corresponding DVMRP REPORT is received, the source
interface is marked as not being an edge router. (This would usually include an
additional timeout until which it is marked as an edge again, but we haven't
implemented this.)

When a packet is received on a link, RPF is first used with the static routing
table. Packets received on a link different than the one that would be used to
send unicast packets back to the sender are dropped, and a DVMRP LEAF message is
sent back to the originating router, who marks us as not being a child for that
route in the route->children array and does not send any further packets from
the same source.

Otherwise, the entry is checked for a corresponding multicast group record,
which also uses a balanced binary tree, and added if not found. This record
has a list of interfaces that are pruned, and whether a PRUNE has also been
sent uptree. Then the following algorithm is run:

For each interface:
	If interface is not an edge interface (gini_dvmrp_edges[iface] == FALSE):
		If interface is not a child (route->children[iface] == FALSE):
			Skip to next interface
		If interface is pruned (route->group[mcastaddr]->pruned[iface] == TRUE):
			Skip to next interface
	Otherwise
		If no local IGMP hosts for multicast group on this interface:
			Skip to next interface

	Forward packet on this interface

If the packet was not forwarded, then a PRUNE message is sent back to the next
hop address, and prune_sent is marked in the group record. Prunes are not timed
out; instead, DVMRP GRAFT messages are sent when the router receives a new
membership to a multicast group. GRAFT messages cause routers to remove the
source interface from the pruned interface list of every group record.

[1] RFC 1075, "Distance Vector Multicast Routing Protocol".
[1] Internet Draft, "DVMRP Version 3".
[3] Deering, S., "Multicast Routing in Internetworks and Extended LANs",
    SIGCOMM Summer 1988 Proceedings, August 1988.

